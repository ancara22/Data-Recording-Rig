<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">modules/client-routes.js | server</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="Data collection and processing server"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="server"><meta property="twitter:description" content="Data collection and processing server"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/ancara22/pi-server"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/modules/cortex.js~Cortex.html">Cortex</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-concatinateWavFiles">concatinateWavFiles</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-detectExterienceSampling">detectExterienceSampling</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-insertToJSON">insertToJSON</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-sendAudioToAWSS3">sendAudioToAWSS3</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-cleanCSVFile">cleanCSVFile</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-cleanOldRowData">cleanOldRowData</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-emptyAllFiles">emptyAllFiles</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-removeStreamFiles">removeStreamFiles</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-insertGSRData">insertGSRData</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-predictGSREmotion">predictGSREmotion</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-processGSRoutput">processGSRoutput</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-rigControl">rigControl</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-resetTimer">resetTimer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-extractTimestamp">extractTimestamp</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getAllEEGFilesContent">getAllEEGFilesContent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getJSONLFileContent">getJSONLFileContent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getTheHash">getTheHash</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-insertDataToFinalFile">insertDataToFinalFile</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-readJSONFile">readJSONFile</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-runImageProcessor">runImageProcessor</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-runSessionFileUpdatingInterval">runSessionFileUpdatingInterval</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-saveData">saveData</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-writeJSONFile">writeJSONFile</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-webClientRoutes">webClientRoutes</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-config">config</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-serverRoutes">serverRoutes</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-APP_CONFIG">APP_CONFIG</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-EXPERIENCE_CONFIG">EXPERIENCE_CONFIG</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-FILE_PATHS">FILE_PATHS</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-RIG_CONFIG">RIG_CONFIG</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-SERVER_CONFIG">SERVER_CONFIG</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">modules/client-routes.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import express from &apos;express&apos;;
import ini from &apos;ini&apos;;
import fs from &apos;fs&apos;;
import csv from &apos;csv-parser&apos;;
import path from &quot;path&quot;;
import { saveData } from &apos;./utility.js&apos;;
import { FILE_PATHS } from &apos;./server_settings.js&apos;;
import { SERVER_CONFIG } from &apos;./server_settings.js&apos;;
import { rigControl } from &apos;./rig_controller.js&apos;;
import { cleanCSVFile } from &apos;./file_cleaners.js&apos;;



//////////////////////////////////////////////////////////////////////////////////
//Clien web-service
//////////////////////////////////////////////////////////////////////////////////

const webClientRoutes = express.Router();

//Web interface/web page
webClientRoutes.get(&quot;/&quot;, (req, res) =&gt; res.sendFile(path.join(__dirname, &apos;/webclient/index.html&apos;)));

//Get rig status for the web client /Web client webservice
webClientRoutes.get(&apos;/rigStatus&apos;, (req, res) =&gt; res.json({
    rigActive: SERVER_CONFIG.rigActive,
    imagesNumber: SERVER_CONFIG.imagesNumber,
    audioNumber: SERVER_CONFIG.audioNumber,
    gsrNumber: SERVER_CONFIG.gsrNumber
}));

//Save new configs to the file
webClientRoutes.get(&quot;/rigStart&quot;, (req, res) =&gt; {
    cleanCSVFile(FILE_PATHS.CLIENT_GSR_GRAPH_FILE_PATH, &apos;Timestamp,GSR&apos;);
    cleanCSVFile(FILE_PATHS.CLIENT_EMOTIONS_PATH, &apos;startTime,endTime,Emotion\n&apos;);
    handleRigControl(req, res, &quot;start&quot;)
});

//Save new configs to the file
webClientRoutes.get(&quot;/rigStop&quot;, (req, res) =&gt; handleRigControl(req, res, &quot;stop&quot;));

//Get gsr data from the file
webClientRoutes.get(&apos;/gsrData&apos;, (req, res) =&gt; {
    readFileAndHandleErrors(FILE_PATHS.CLIENT_GSR_GRAPH_FILE_PATH, res, (data) =&gt; {
        let rows = data.trim().split(&apos;\n&apos;),
            header = rows[0].split(&apos;,&apos;),
            gsr_data = rows.slice(1).map(row =&gt; row.split(&apos;,&apos;).map(parseFloat));

        res.status(200).json({ header, gsr_data });
    })
});

//getRigConfigFile
webClientRoutes.get(&apos;/getConfig&apos;, (req, res) =&gt; {
    readFileAndHandleErrors(FILE_PATHS.CONFIG_FILE_PATH, res, (data) =&gt; {
        const config = ini.parse(data)
        res.status(200).json({ config });
    })
});

//Save new configs to the file
webClientRoutes.post(&quot;/saveConfig&quot;, (req, res) =&gt; {
    const config = req.body.config,
        iniConfig = ini.stringify(config);

    fs.writeFile(FILE_PATHS.CONFIG_FILE_PATH, iniConfig, (err) =&gt; {
        if (err) {
            config.toUpdateConfig = false;
            console.error(&apos;Error saving INI file:&apos;, err);
            res.status(500);
        } else {
            config.toUpdateConfig = true;
            rigControl(&apos;config&apos;);
            res.status(200);
        }
    });
});

//Save new configs to the file
webClientRoutes.get(&quot;/getEmotions&quot;, (req, res) =&gt; {
    readFileAndHandleErrors(FILE_PATHS.CLIENT_EMOTIONS_PATH, res, (data) =&gt; {
        let rows = data.trim().split(&apos;\n&apos;),
            header = rows[0].split(&apos;,&apos;),
            emotions = rows.slice(1).map(row =&gt; row.split(&apos;,&apos;));

        res.status(200).json({ header, emotions });
    });
});

//Set the new username and session start time
webClientRoutes.post(&apos;/setNewUserName&apos;, (req, res) =&gt; {
    let name = req.body.userName;

    readFileAndHandleErrors(FILE_PATHS.USER_FILE_PATH, res, (data) =&gt; {
        let userData = JSON.parse(data); //Get the data from the json file

        userData.sessionStart = Math.floor(Date.now() / 1000);
        userData.currentUser = name;

        let updatedData = JSON.stringify(userData, null, 4);

        //Rewrite the json file
        fs.writeFile(FILE_PATHS.USER_FILE_PATH, updatedData, &apos;utf8&apos;, (err) =&gt; {
            if (err) console.error(&apos;Error updating JSON file:&apos;, err)
        })

        res.status(200)
    })
})

//Get the user name and session start time
webClientRoutes.get(&apos;/getUserName&apos;, (req, res) =&gt; {
    readFileAndHandleErrors(FILE_PATHS.USER_FILE_PATH, res, (data) =&gt; {
        res.send(data);
    })
})

//Get Extracted Audio text
webClientRoutes.get(&apos;/getAudioText&apos;, (req, res) =&gt; {
    readFileAndHandleErrors(FILE_PATHS.AUDIO_TEXT_FILE_PATH, res, (data) =&gt; {
        res.send(data)
    })
});

//Get extracted Image text
webClientRoutes.get(&apos;/getImageText&apos;, (req, res) =&gt; {
    readCsvAndHandleErrors(FILE_PATHS.IMAGE_TEXT_FILE_PATH, res, (data) =&gt; {
        res.json(data)
    })
});

//Save audio user intro
webClientRoutes.post(&quot;/saveAudioIntro&quot;, saveData(&apos;user&apos;, &apos;audio&apos;), (req, res) =&gt; {
    res.json({
        success: true,
        message: &apos;Audio data saved successfully.&apos;
    });
});

webClientRoutes.get(&quot;/getAllSessions&quot;, (req, res) =&gt; {
    fs.readdir(FILE_PATHS.SESSION_FOLDER, (err, files) =&gt; {
        if (err) {
            console.error(&apos;Error reading folder:&apos;, err);
            return;
        }

        //Filter files with the extension &apos;.json&apos;
        const matchingFiles = files.map(file =&gt; {
            const extension = path.extname(file),
                fileName = path.basename(file, extension);

            if(extension === &apos;.json&apos;) return fileName;
        })

        res.json(matchingFiles);
    }) 
});


webClientRoutes.post(&quot;/getAllImages&quot;, (req, res) =&gt; {
    let startTime = Math.floor(req.body.startTime / 1000);

    fs.readdir(FILE_PATHS.PROCESSED_IMAGES, (err, files) =&gt; {
        if (err) {
            console.error(&apos;Error reading folder:&apos;, err);
            return;
        }

        //Filter files with the extension &apos;.json&apos;
        const matchingFiles = files.filter(file =&gt; {
            const extension = path.extname(file),
                fileName = path.basename(file, extension);

            let time = parseInt(fileName.split(&quot;-&quot;)[0]);
            let diferenceTime = time - startTime;
            let frameTime = 60 * 60;

            if(extension === &apos;.jpg&apos; &amp;&amp; diferenceTime &lt; frameTime) return fileName;
        })

        res.json(matchingFiles);
    }) 
});


webClientRoutes.post(&quot;/getAllAudioFiles&quot;, (req, res) =&gt; {
    let startTime = Math.floor(req.body.startTime / 1000);

    fs.readdir(FILE_PATHS.CONVERTED_AUDIO, (err, files) =&gt; {
        if (err) {
            console.error(&apos;Error reading folder:&apos;, err);
            return;
        }

        //Filter files with the extension &apos;.json&apos;
        const matchingFiles = files.filter(file =&gt; {
            const extension = path.extname(file),
                fileName = path.basename(file, extension);

            let time = parseInt((fileName.split(&quot;_&quot;)[1]).split(&quot;.&quot;)[0]);
            let diferenceTime = time - startTime;
            let frameTime = 60 * 60;

            if(extension === &apos;.wav&apos; &amp;&amp; diferenceTime &lt; frameTime) return fileName;
        })

        res.json(matchingFiles);
    }) 
});


//Read the file and return the file content
webClientRoutes.post(&quot;/getOutputFileContent&quot;, (req, res) =&gt; {
    const requestBody = req.body;

    if (!requestBody || !requestBody.fileName) {
        return res.status(400).json({ error: &apos;Invalid request. fileName is required.&apos; });
    }

    let filePath = FILE_PATHS.SESSION_FOLDER + requestBody.fileName;

    fs.readFile(filePath, &apos;utf8&apos;, (err, data) =&gt; {
        if (err) {
            return res.status(500).json({ error: &apos;Error reading file.&apos;, details: err.message });
        }

        //Parse the JSON data
        let jsonOutput;

        try {
            jsonOutput = JSON.parse(data);
        } catch (parseError) {
            return res.status(500).json({ error: &apos;Error parsing JSON.&apos;, details: parseError.message });
        }

        //Send back the json file content
        res.json(jsonOutput);
    });


})

//Read the file and return the file content
webClientRoutes.post(&quot;/getAudioFilePath&quot;, (req, res) =&gt; {
    const audioFileName = req.body.audioFileName;
    const __dirname = path.resolve();

    const audioFilePath = path.join(__dirname, &apos;data&apos;, &apos;audio&apos;, &apos;processed_audio&apos;, audioFileName);

    res.sendFile(audioFilePath)

})

//Read the file and return the file content
webClientRoutes.post(&quot;/getImage&quot;, (req, res) =&gt; {
    const imageName = req.body.imageName;
    const __dirname = path.resolve();

    const imagePath = path.join(__dirname, &apos;data&apos;, &apos;images&apos;, &apos;processed_images&apos;, imageName);

    res.sendFile(imagePath)

})


//################################################################################################################################################
// Functions
//################################################################################################################################################

//Read a JSON file function with callback
function readFileAndHandleErrors(filePath, res, callback) {
    fs.readFile(filePath, &apos;utf8&apos;, (err, data) =&gt; {
        if (err) {
            console.error(err);
            res.status(500);
        } else {
            callback(data);
        }
    });
}

//Handle rig control
function handleRigControl(req, res, action) {
    rigControl(action);
    res.status(200);
}

//Read CSV file
function readCsvAndHandleErrors(filePath, res, callback) {
    try {
        const data = [];

        fs.createReadStream(filePath)
            .pipe(csv())
            .on(&apos;data&apos;, (row) =&gt; {
                data.push(row);
            })
            .on(&apos;end&apos;, () =&gt; {
                // Transform data and extract information
                const transformedData = data.map((item) =&gt; {
                    const imageNameMatch = item.image.match(/(\d+)-stream\.jpg/),
                        imageId = imageNameMatch ? imageNameMatch[1] : null;

                    return {
                        imageName: item.image,
                        imageTime: new Date(parseInt(imageId) * 1000).toLocaleString(),
                        text: item.text,
                    };
                });

                callback(transformedData);
            }).on(&apos;error&apos;, (err) =&gt; {
                console.error(&apos;Error reading CSV:&apos;, err);
                res.status(500).send(&apos;Internal Server Error&apos;);
            });
    } catch (err) {
        console.log(&apos;Error reading CSV file: &apos;, err);
    }
}
//Export
export {  webClientRoutes }</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
