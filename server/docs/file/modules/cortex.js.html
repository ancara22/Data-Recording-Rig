<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">modules/cortex.js | server</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="Data collection and processing server"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="server"><meta property="twitter:description" content="Data collection and processing server"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/ancara22/pi-server"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/modules/cortex.js~Cortex.html">Cortex</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-concatinateWavFiles">concatinateWavFiles</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-detectExterienceSampling">detectExterienceSampling</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-insertToJSON">insertToJSON</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-sendAudioToAWSS3">sendAudioToAWSS3</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-cleanCSVFile">cleanCSVFile</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-cleanOldRowData">cleanOldRowData</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-emptyAllFiles">emptyAllFiles</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-removeStreamFiles">removeStreamFiles</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-insertGSRData">insertGSRData</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-predictGSREmotion">predictGSREmotion</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-processGSRoutput">processGSRoutput</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-rigControl">rigControl</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-resetTimer">resetTimer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-extractTimestamp">extractTimestamp</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getAllEEGFilesContent">getAllEEGFilesContent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getJSONLFileContent">getJSONLFileContent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getTheHash">getTheHash</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-insertDataToFinalFile">insertDataToFinalFile</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-readJSONFile">readJSONFile</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-runImageProcessor">runImageProcessor</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-runSessionFileUpdatingInterval">runSessionFileUpdatingInterval</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-saveData">saveData</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-writeJSONFile">writeJSONFile</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-webClientRoutes">webClientRoutes</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-config">config</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-serverRoutes">serverRoutes</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-APP_CONFIG">APP_CONFIG</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-EXPERIENCE_CONFIG">EXPERIENCE_CONFIG</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-FILE_PATHS">FILE_PATHS</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-RIG_CONFIG">RIG_CONFIG</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-SERVER_CONFIG">SERVER_CONFIG</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">modules/cortex.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import WebSocket from &apos;ws&apos;;
import fs from &quot;fs&quot;;

//Headset responses code
const WARNING_CODE_HEADSET_DISCOVERY_COMPLETE = 142;
const WARNING_CODE_HEADSET_CONNECTED = 104;


//EEG Headset controler
export class Cortex {
    constructor(user, socketUrl) {
        //Data web-socket
        this.socket = new WebSocket(socketUrl, { rejectUnauthorized: false });

        //Start settings
        this.user = user
        this.isHeadsetConnected = false
    }

    //Sumscript to the data, get data from the headset
    sub(streams){
        this.socket.on(&apos;open&apos;,async ()=&gt;{
            //Check the authentification 
            await this.checkGrantAccessAndQuerySessionInfo()

            //Run the subbscription to the data
            this.subRequest(streams, this.authToken, this.sessionId)
        })
    }

    //Refresh headset list /scaning the available devices
    refreshHeadsetList() {
        const REFRESH_HEADSET_LIST_ID = 14;

        const refreshHeadsetListRequest = {
            &quot;jsonrpc&quot;: &quot;2.0&quot;,
            &quot;id&quot;: REFRESH_HEADSET_LIST_ID,
            &quot;method&quot;: &quot;controlDevice&quot;,
            &quot;params&quot;: {
                &quot;command&quot;: &quot;refresh&quot;
            }
        };

        //Send the command to refresh the bluetooth scanner
        socket.send(JSON.stringify(refreshHeadsetListRequest));
    }

    //Query headset id
    queryHeadsetId() {
        return new Promise((resolve, reject) =&gt; {
            const QUERY_HEADSET_ID = 2;
            let socket = this.socket;

            let queryHeadsetRequest = {
                &quot;jsonrpc&quot;: &quot;2.0&quot;,
                &quot;id&quot;: QUERY_HEADSET_ID,
                &quot;method&quot;: &quot;queryHeadsets&quot;,
                &quot;params&quot;: {}
            };

            const sendQueryRequest = () =&gt; {
                socket.send(JSON.stringify(queryHeadsetRequest));
            };
            
            sendQueryRequest();
    
            //Check headset availability/ manage response message
            socket.on(&apos;message&apos;, (data) =&gt; {
                try {
                    if(JSON.parse(data)[&apos;id&apos;]==QUERY_HEADSET_ID){
                        if(JSON.parse(data)[&apos;result&apos;].length &gt; 0){
                            JSON.parse(data)[&apos;result&apos;].forEach(headset =&gt; {
                                if (headset[&apos;status&apos;] === &apos;connected&apos;) {
                                    this.isHeadsetConnected = true;
                                }
                            });
                            resolve(JSON.parse(data))
                        } else {
                            console.log(&apos;No have any headset, please connect headset with your pc.&apos;)
                            this.isHeadsetConnected = false
                        }
                    }
                } catch (error) {
                    console.error(error);
                }
            });
    
            //Schedule subsequent requests every 1 minute
            setInterval(sendQueryRequest, 60000);
        });
    }

    //Request acces to the api/headset
    requestAccess(){
        let socket = this.socket
        let user = this.user

        return new Promise(function(resolve, reject){
            const REQUEST_ACCESS_ID = 1

            let requestAccessRequest = {
                &quot;jsonrpc&quot;: &quot;2.0&quot;, 
                &quot;method&quot;: &quot;requestAccess&quot;, 
                &quot;params&quot;: { 
                    &quot;clientId&quot;: user.clientId, 
                    &quot;clientSecret&quot;: user.clientSecret
                },
                &quot;id&quot;: REQUEST_ACCESS_ID
            }

            //Request acces
            socket.send(JSON.stringify(requestAccessRequest));

            //Handle request acces response
            socket.on(&apos;message&apos;, (data)=&gt;{
                try {
                    if(JSON.parse(data)[&apos;id&apos;] == REQUEST_ACCESS_ID) resolve(data);
                } catch (error) {}
            })
        })
    }

    //Control hadset
    controlDevice(headsetId){
        let socket = this.socket
        const CONTROL_DEVICE_ID = 3

        let controlDeviceRequest = {
            &quot;jsonrpc&quot;: &quot;2.0&quot;,
            &quot;id&quot;: CONTROL_DEVICE_ID,
            &quot;method&quot;: &quot;controlDevice&quot;,
            &quot;params&quot;: {
                &quot;command&quot;: &quot;connect&quot;,
                &quot;headset&quot;: headsetId
            }
        }

        return new Promise(function(resolve, reject){
            socket.send(JSON.stringify(controlDeviceRequest));

            socket.on(&apos;message&apos;, (data)=&gt;{
                try {
                    let response = JSON.parse(data);
                    if(response[&apos;id&apos;] == CONTROL_DEVICE_ID){
                        if(response.error) {
                            console.log(response.error.message);
                            setTimeout(() =&gt; {
                                socket.send(JSON.stringify(controlDeviceRequest));
                            }, 10000);
                        } else {
                            resolve(response);
                        }
                    }
                } catch (error) {}
            })
        }) 
    }

    //Authorize user
    authorize(){
        let socket = this.socket
        let user = this.user

        return new Promise(function(resolve, reject){
            const AUTHORIZE_ID = 4

            let authorizeRequest = { 
                &quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;authorize&quot;, 
                &quot;params&quot;: { 
                    &quot;clientId&quot;: user.clientId, 
                    &quot;clientSecret&quot;: user.clientSecret, 
                    &quot;license&quot;: user.license,
                    &quot;debit&quot;: user.debit
                },
                &quot;id&quot;: AUTHORIZE_ID
            }

            socket.send(JSON.stringify(authorizeRequest))

            socket.on(&apos;message&apos;, (data)=&gt;{
                try {
                    if(JSON.parse(data)[&apos;id&apos;]==AUTHORIZE_ID){
                        let cortexToken = JSON.parse(data)[&apos;result&apos;][&apos;cortexToken&apos;]
                        resolve(cortexToken)

                        //Call controlDevice(&quot;refresh&quot;) when authorization is successful
                        this.refreshHeadsetList();
                    }
                } catch (error) {}
            })
        })
    }

    //Create session with the headset
    createSession(authToken, headsetId) {
        const CREATE_SESSION_ID = 5;

        return new Promise(async (resolve, reject) =&gt; {
            let socket = this.socket;
            let sessionId;

            const checkHeadsetId = async () =&gt; {
                const response = await this.queryHeadsetId();

                const found = response[&quot;result&quot;].find(item =&gt; String(item[&quot;id&quot;]) === String(headsetId) &amp;&amp; item[&quot;status&quot;] === &quot;connected&quot;);
                if (found) {
                    clearInterval(queryInterval);

                    let createSessionRequest = {
                        &quot;jsonrpc&quot;: &quot;2.0&quot;,
                        &quot;id&quot;: CREATE_SESSION_ID,
                        &quot;method&quot;: &quot;createSession&quot;,
                        &quot;params&quot;: {
                            &quot;cortexToken&quot;: authToken,
                            &quot;headset&quot;: headsetId,
                            &quot;status&quot;: &quot;active&quot;
                        }
                    };

                    socket.send(JSON.stringify(createSessionRequest));
    
                    socket.on(&apos;message&apos;, (data) =&gt; {
                        let parsedData = JSON.parse(data);

                        if (parsedData.id === CREATE_SESSION_ID) {
                            sessionId = parsedData[&apos;result&apos;][&apos;id&apos;];
                            resolve(sessionId);
                        }
                    });
                }
            };
            const queryInterval = setInterval(checkHeadsetId, 30000);
            checkHeadsetId();
        });
    }

    //Subrequest, sned the subscription to the EEG data, and handle the result 
    subRequest(stream, authToken, sessionId){
        let socket = this.socket
        const SUB_REQUEST_ID = 6 

        let subRequest = { 
            &quot;jsonrpc&quot;: &quot;2.0&quot;, 
            &quot;method&quot;: &quot;subscribe&quot;, 
            &quot;params&quot;: { 
                &quot;cortexToken&quot;: authToken,
                &quot;session&quot;: sessionId,
                &quot;streams&quot;: stream
            }, 
            &quot;id&quot;: SUB_REQUEST_ID
        }

        socket.send(JSON.stringify(subRequest))

        //Handle data receiving
        socket.on(&apos;message&apos;, (data)=&gt;{
            try {
                let parsedData = JSON.parse(data.toString(&apos;utf8&apos;)); //Received data from the headsetr
                //console.log(parsedData + &apos;\r\n&apos;));

                this.handleData(parsedData); //Format data and save
            } catch (error) {}
        })
    }

    /**
     * - query headset infor
     * - connect to headset with control device request
     * - authentication and get back auth token
     * - create session and get back session id
     */
    async querySessionInfo(){
        let qhResult = &quot;&quot;, headsetId = &quot;&quot;, ctResult = &quot;&quot;, authToken = &quot;&quot;, sessionId = &quot;&quot;

        //Query headset id
        await this.queryHeadsetId().then((result)=&gt;{qhResult = result})
        this.qhResult = qhResult
        this.headsetId = qhResult[&apos;result&apos;][0][&apos;id&apos;]

        //Control device
        await this.controlDevice(this.headsetId).then((result)=&gt;{ctResult=result})
        this.ctResult = ctResult
        console.log(ctResult)

        //Authorize session
        await this.authorize().then((auth)=&gt;{authToken = auth})
        this.authToken = authToken

        //Create session
        await this.createSession(authToken, this.headsetId).then((result)=&gt;{sessionId=result})
        this.sessionId = sessionId
    }

    /**
     * - check if user logined
     * - check if app is granted for access
     * - query session info to prepare for sub and train
    */
    async checkGrantAccessAndQuerySessionInfo(){
        let requestAccessResult = &quot;&quot;

        //Request acces
        await this.requestAccess().then((result)=&gt;{requestAccessResult=result})

        //Acces status
        let accessGranted = JSON.parse(requestAccessResult)
    
        //Check if user is logged in CortexUI
        if (&quot;error&quot; in accessGranted){
            console.log(&apos;You must login on CortexUI before request for grant access then rerun&apos;)
            throw new Error(&apos;You must login on CortexUI before request for grant access&apos;)
        }else{
            console.log(accessGranted[&apos;result&apos;][&apos;message&apos;])
            // console.log(accessGranted[&apos;result&apos;])
            if(accessGranted[&apos;result&apos;][&apos;accessGranted&apos;]){
                await this.querySessionInfo()
            }
            else{
                console.log(&apos;You must accept access request from this app on CortexUI then rerun&apos;)
                throw new Error(&apos;You must accept access request from this app on CortexUI&apos;)
            }
        }   
    }

    //Listend the socket warnings
    listenForWarnings() {
        this.socket.on(&apos;message&apos;, (data) =&gt; {
            try {
                const message = JSON.parse(data);
                if (message.warning) {
                    console.log(&apos;Warning Received Code:&apos;, message.warning.code);
                    console.log(&apos;Message:&apos;, message.warning.message);
                    console.log(&apos;--------------------------------------&apos;);

                    if (message.warning.code === WARNING_CODE_HEADSET_CONNECTED) {
                        this.isHeadsetConnected = true;
                    }

                    // After headset scanning finishes, if no headset is connected yet, the app should call the controlDevice(&quot;refresh&quot;) again
                    if (message.warning.code === WARNING_CODE_HEADSET_DISCOVERY_COMPLETE &amp;&amp; !this.isHeadsetConnected) {
                        this.refreshHeadsetList();
                    }
                } 
            } catch (error) {}
        });
    }

    //Handle received data
    handleData(receivedData) {
        let type = Object.keys(receivedData)[0];

        if(type == &quot;eeg&quot;) {
            //Row EEG data
            this.insertDataToJsonl(&quot;row_eeg.jsonl&quot;, receivedData);
        } else if(type == &quot;fac&quot;) {
            //Facial Expresions
            this.insertDataToJsonl(&quot;facial_expressions.jsonl&quot;, receivedData);
        } else if(type == &quot;pow&quot;) {
            //Performance metrics
            this.insertDataToJsonl(&quot;power_of_sensors.jsonl&quot;, receivedData);
        } else if(type == &quot;met&quot;) {
            //Performance metrics
            this.insertDataToJsonl(&quot;performance_metrics.jsonl&quot;, receivedData);
        }
    }

    //Append received data to file
    insertDataToJsonl(fileName, data) {
        let jsonData = JSON.stringify(data) + &quot;\n&quot;; //jsonl line

        fs.appendFile(&quot;./data/eeg/&quot; + fileName, jsonData, (error) =&gt; {
            if(error) throw error;
            
            //console.log(&apos;Data appended to&apos;, fileName);
        })

    }

    //Run the headset streaming
    run() {
        this.listenForWarnings();

        /*
            Have six kind of stream data [&apos;fac&apos;, &apos;pow&apos;, &apos;eeg&apos;, &apos;mot&apos;, &apos;met&apos;, &apos;com&apos;]

            eeg - The raw EEG data from the headset
            fac - The results of the facial expressions detection
            met - The results of the performance metrics detection (Attention level, Stress level, etc)

            mot - The motion data from the headset
            pow - The band power of each EEG sensor. It includes the alpha, low beta, high beta, gamma, and theta bands
            com - The results of the mental commands detection. 
        */
        let streams = [&apos;eeg&apos;, &apos;fac&apos;, &apos;met&apos;, &apos;pow&apos;]

        this.sub(streams);
    }
    
}








</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
