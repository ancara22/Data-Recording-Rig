<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">modules/aws_services.js | server</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="Data collection and processing server"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="server"><meta property="twitter:description" content="Data collection and processing server"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/ancara22/pi-server"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/modules/cortex.js~Cortex.html">Cortex</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-concatinateWavFiles">concatinateWavFiles</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-detectExterienceSampling">detectExterienceSampling</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-insertToJSON">insertToJSON</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-sendAudioToAWSS3">sendAudioToAWSS3</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-cleanCSVFile">cleanCSVFile</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-cleanOldRowData">cleanOldRowData</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-emptyAllFiles">emptyAllFiles</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-removeStreamFiles">removeStreamFiles</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-insertGSRData">insertGSRData</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-predictGSREmotion">predictGSREmotion</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-processGSRoutput">processGSRoutput</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-rigControl">rigControl</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-resetTimer">resetTimer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-extractTimestamp">extractTimestamp</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getAllEEGFilesContent">getAllEEGFilesContent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getJSONLFileContent">getJSONLFileContent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getTheHash">getTheHash</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-insertDataToFinalFile">insertDataToFinalFile</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-readJSONFile">readJSONFile</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-runImageProcessor">runImageProcessor</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-runSessionFileUpdatingInterval">runSessionFileUpdatingInterval</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-saveData">saveData</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-writeJSONFile">writeJSONFile</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-webClientRoutes">webClientRoutes</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-config">config</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-serverRoutes">serverRoutes</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-APP_CONFIG">APP_CONFIG</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-EXPERIENCE_CONFIG">EXPERIENCE_CONFIG</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-FILE_PATHS">FILE_PATHS</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-RIG_CONFIG">RIG_CONFIG</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-SERVER_CONFIG">SERVER_CONFIG</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">modules/aws_services.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import AWS from &apos;aws-sdk&apos;;
import fs from &apos;fs&apos;;
import https from &apos;https&apos;;
import { readJSONFile, extractTimestamp } from &quot;./utility.js&quot;;
import { exec } from &apos;child_process&apos;;
import { FILE_PATHS, EXPERIENCE_CONFIG } from &quot;./server_settings.js&quot;;

//Configure AWS region
AWS.config.update({ region: &apos;eu-west-2&apos; });

//Initiate AWS components
const transcribeService = new AWS.TranscribeService(); //Init AWS Transcriber
const S3 = new AWS.S3();                               //Init AWS S3 Bucket
const comprehend = new AWS.Comprehend();               //Init AWS Comprehend


//Insert audio file to the AWS S3 Bucket 
function sendAudioToAWSS3(audioFile) {
    let filePath = FILE_PATHS.ROW_AUDIO_FOLDER_PATH + audioFile,
        convertedFilePath = FILE_PATHS.CONVERTED_AUDIO + audioFile;

    concatinateWavFiles(filePath, () =&gt; {
        //Configure the AWS bucket
        const bucketName = &apos;audiobucketfortranscirber&apos;;

        fs.readFile(convertedFilePath, (err, data) =&gt; {
            if (err) console.log(&apos;File reading error: &apos;, err)

            //Upload the audio file to the AWS S3 bucket
            S3.upload({
                Bucket: bucketName,
                Key: audioFile,
                Body: data
            }, (error, result) =&gt; {
                if (error) console.log(&apos;Error uploading the audio file to the bucket:&apos;, error);
                else transcribeTheAudioFile(audioFile); //Run the Transcriber job
            })
        });
    });  
}

//Create and run the Transcriber job on the AWS Transcriber service
function transcribeTheAudioFile(audioFile) {
    let transcriptionJobName = &quot;audioT_&quot; + audioFile.replace(&apos;.wav&apos;, &apos;&apos;); //Create a unic job name

    //Job params
    const params = {
        TranscriptionJobName: transcriptionJobName,
        LanguageCode: &quot;en-US&quot;,
        Media: {
            MediaFileUri: &quot;s3://audiobucketfortranscirber/&quot; + audioFile
        },
        MediaFormat: &quot;wav&quot;,
        MediaSampleRateHertz: 44100,
        Settings: {
            MaxSpeakerLabels: 2,
            ShowSpeakerLabels: true,
        }
    };

    //Run the transcriber
    transcribeService.startTranscriptionJob(params, (err, resp) =&gt; {
        if (err) console.log(err, err.stack);
        else getTranscriptionStatus(transcriptionJobName, audioFile); //Check the job status
    });
}

//Request to the AWS Trascriber job, to get the job status
function getTranscriptionStatus(transcriptionJobName, audioFile) {
    //Send the request
    transcribeService.getTranscriptionJob({
        TranscriptionJobName: transcriptionJobName
    }, (err, data) =&gt; {
        //Check connection
        if (err) {
            console.log(&apos;Transcriber Job error:&apos;, err);
            return 0;
        }

        let job_status = data.TranscriptionJob.TranscriptionJobStatus; //Get the status

        //Manage the status
        if (job_status == &apos;FAILED&apos;) {
            console.log(&apos;Transcriber process error!&apos;);
        } else if (job_status == &apos;COMPLETED&apos;) {
            console.log(&apos;Transcriber process completed!&apos;)

            let result_file_url = data.TranscriptionJob.Transcript.TranscriptFileUri; //Get the Trascriber result file url
            getTranscriptionData(result_file_url, audioFile); //Get the Transcriber data from the url
        } else {
            setImmediate(() =&gt; getTranscriptionStatus(transcriptionJobName, audioFile), 20000); //Repeat the request, if there is no result yet
        }
    })
}

//Get Transcriber output
function getTranscriptionData(result_file_url, audioFile) {
    let outputPath = &apos;./data/audio/&apos; + (audioFile.replace(&apos;.wav&apos;, &apos;.json&apos;)); //Output file name
    let file = fs.createWriteStream(outputPath); //Create a empty file

    //Request the data
    https.get(result_file_url, (response) =&gt; {
        response.pipe(file);

        //Once request finish, get data
        file.on(&apos;finish&apos;, () =&gt; {
            file.close(() =&gt; {
                insertToJSON(outputPath, audioFile)
            });
        });

    }).on(&apos;error&apos;, (err) =&gt; console.error(&apos;Error downloading JSON file:&apos;, err));
}

//Insert audio transcribed data in an json file
function insertToJSON(outputPath, audioFile) {
    //One speaker data
    let newData = {
        timestamp: undefined,
        text: [],
        audio_file: undefined,
        experienceDetected: &quot;&quot;,
        text_emotion: &quot;&quot;
    }

    //Format the comversation
    formatTheAudioJson(outputPath, newData)
        .then(() =&gt; {
            //Get the timestamp from the file name
            let str = audioFile.match(/\d+/);
            let timestamp = str ? parseInt(str[0], 10) : null;

            newData.audio_file = audioFile; //Add the audio file name
            newData.timestamp = timestamp; //Add the audio start timestamp

            try {
                if (newData.text.length &gt; 0) {
                    //Read the final json file
                    fs.readFile(FILE_PATHS.AUDIO_TEXT_FILE_PATH, &apos;utf8&apos;, (err, data) =&gt; {
                        if (err) {
                            console.error(&apos;Error reading JSON file:&apos;, err);
                            return;
                        }

                        let experienceDetected = detectExterienceSampling(newData); //Detect/Get the experience recording in the extracted text from audio

                        setTimeout(() =&gt; {
                            if (experienceDetected != &quot;&quot;) newData.experienceDetected = experienceDetected;
                            else newData.experienceDetected = undefined;

                            let dataObject = JSON.parse(data); //Parse the json data to object
                            dataObject.push(newData); //Add the new data to the file object

                            let dataJson = JSON.stringify(dataObject, null, 4); //Convert the object to json


                            //Write the json file
                            fs.writeFile(FILE_PATHS.AUDIO_TEXT_FILE_PATH, dataJson, &apos;utf8&apos;, (err) =&gt; {
                                if (err) console.error(&apos;Error updating JSON file:&apos;, err)
                            })
                        }, 1000)
                    })
                }
            } catch (e) {
                console.log(&apos;Error reading the audio json file.&apos;)
            }

            removeAJsonFile(outputPath); //Remove the json file(the transcribed file from one audio data)
        }).catch(err =&gt; {
            console.log(&apos;Error formating: &apos;, err);
        })
}

//Format the conversation to json format
function formatTheAudioJson(filePath, respons) {
    return new Promise(async (resolve, reject) =&gt; {
        readJSONFile(FILE_PATHS.USER_FILE_PATH, (user) =&gt; {
            try {
                let words, content = &apos;&apos;,
                    newSpeaker = false;

                //Read the input file/from transcriber
                readJSONFile(filePath, (data) =&gt; {
                    //One speaker data
                    let speakerData = {
                        speaker: undefined,
                        text: &apos;&apos;
                    }

                    extractEmotionsFromText(data.results.transcripts[0].transcript)
                        .then(emotion =&gt; {
                            respons.text_emotion = emotion;

                            return true;
                        }).then(() =&gt; {
                            words = data[&quot;results&quot;][&quot;items&quot;]; //Get the extracted words

                            let s = 0; //Speakers count

                            for (let i in words) {
                                let speaker_label = words[i][&quot;speaker_label&quot;];

                                //Control the current speaker id
                                if (!speakerData.speaker) {
                                    speakerData.speaker = speaker_label; //Set the first speaker

                                    respons.text.push(speakerData); //Add the speakers data
                                    
                                } else if (speakerData.speaker != speaker_label) {
                                    newSpeaker = true;
                                    speakerData = {
                                        speaker: &apos;&apos;,
                                        text: &apos;&apos;
                                    } //Clean the speaker data, prepare for the next speaker
                                }

                                respons.text[s].text = content.replace(/\s([.,?!])/g, &apos;$1&apos;); //Update the speaker speach

                                //Change the speaker
                                if (newSpeaker) {
                                    s++; //Next speaker
                                    speakerData.speaker = speaker_label; //Speaker data frame
                                    
                                    speakerData.text = &apos;&apos;;
                                    content = &apos;&apos;;

                                    respons.text.push(speakerData);
                                    respons.text[s].text = content.replace(/\s([.,?!])/g, &apos;$1&apos;);

                                    newSpeaker = false;
                                } else {
                                    content += &apos; &apos;;
                                }

                                content += words[i][&quot;alternatives&quot;][0][&quot;content&quot;]; //Add the next word
                                respons.text[s].text = content.replace(/\s([.,?!])/g, &apos;$1&apos;);
                            }

                            processTextObject(respons, user.currentUser);

                            resolve();
                        }).catch(err =&gt; {
                            console.log(&apos;Error extracting emotions: &apos;, err)
                        })
                });

            } catch (err) {
                reject(err);
            }
        })
    })
}

//Remove the a file
function removeAJsonFile(filePath) {
    fs.unlink(filePath, (err) =&gt; {
        if (err) console.error(&apos;Error removing file:&apos;, err)
    });
}

//Detect user exterience from the audio text
function detectExterienceSampling(dataObject) {
    let str = &quot;&quot;,
        data = dataObject.text;

    //Concatinate the discusion in one string
    for (let i = 0; i &lt; data.length; i++)
        str += data[i].text + &quot; &quot;;

    //Define the patterns
    const pattern1 = new RegExp(`${EXPERIENCE_CONFIG.EXPERIENCE_START_KEYWORDS}(.*?)(?:${EXPERIENCE_CONFIG.EXPERIENCE_END_KEYWORDS})`, &apos;i&apos;); //Patttern, start and end phrases
    const pattern2 = new RegExp(`${EXPERIENCE_CONFIG.EXPERIENCE_START_KEYWORDS}(.*?)(?:${EXPERIENCE_CONFIG.EXPERIENCE_END_KEYWORDS}|\\b.{0,${EXPERIENCE_CONFIG.EXPERIENCE_AUTO_LENGTH}}\\b)`, &apos;i&apos;); //Pattern, start - no end

    //Find matches
    const match1 = pattern1.exec(str);
    const match2 = pattern2.exec(str);

    //Get the result if match is not null
    if (match1 || match2) {
        let extractedText = &apos;&apos;;

        // Extract the matched text
        if (match1 &amp;&amp; match1[1] != &apos;&apos;) extractedText = match1[1].trim();
        else extractedText = (match2[0].trim()).slice(14);

        return extractedText;
    } else {
        return null;
    }
}

//Extract wmotions from text using AWS Comprehend
function extractEmotionsFromText(text) {
    return new Promise(async (resolve, reject) =&gt; {
        try {
            const params = {
                LanguageCode: &apos;en&apos;,
                Text: text
            };
            const result = await comprehend.detectSentiment(params).promise();

            resolve(result);
        } catch (error) {
            reject(error)
        }
    });
}

//Concatinate audio file to user intro
function concatinateWavFiles(wavFile, callback) {
    let fileEndTimestamp = extractTimestamp(wavFile),
        filePath = FILE_PATHS.CONVERTED_AUDIO + &quot;audio_&quot; + fileEndTimestamp + &quot;.wav&quot;;

    let userIntro = FILE_PATHS.USER_INTRO_AUDIO_PATH;
    let userIntroConverted = &apos;./data/user/userIntroConverted.wav&apos;;   
    
    //Convert the User audio intro and concatinate the files
    exec(`sox ${userIntro} -r 44100 -c 1 ${userIntroConverted}`, (conversionError) =&gt; {
        if (conversionError) {
            console.error(&apos;Error during file conversion:&apos;, conversionError);
        } else {
            console.log(&apos;first&apos;, wavFile)
            const command = `sox ${userIntroConverted} ${wavFile} ${filePath}`;
            
            exec(command, (concatenationError) =&gt; {
                if (concatenationError) {
                    console.error(&apos;Error during concatenation:&apos;, concatenationError);
                } else {
                    console.log(&apos;Concatenation successful&apos;);

                    fs.unlink(wavFile, (unlinkError) =&gt; {
                        if (unlinkError) {
                            console.error(&apos;Error removing original audio file:&apos;, unlinkError);
                        } else {
                            console.log(&apos;Original audio file removed&apos;);
                        }
        
                        callback();
                    });
                }
            });

            
        }
    })
}

//Remove the user introduction text from the conversation an label him
function processTextObject(inputObject, username) {
    if (inputObject &amp;&amp; inputObject.text &amp;&amp; Array.isArray(inputObject.text)) {
        inputObject.text.shift();   //Remove the first element from the &apos;text&apos; array

        //Rename &apos;speaker&apos; to &apos;username&apos; if it is equal to &apos;spk_0&apos;
        inputObject.text.forEach((item) =&gt; {
            if (item.speaker === &apos;spk_0&apos;) {
                item.speaker = username;
            }
        });
    }
}

export {
    sendAudioToAWSS3,
    insertToJSON,
    detectExterienceSampling,
    concatinateWavFiles
}</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
